---
import type { GetStaticPaths } from 'astro'
import Layout from '../layouts/Layout.astro'
import { DinoStartScreen } from '../components/DinoStartScreen'
import { PreloadSceneImages } from '@/components/PreloadSceneImages'
import { dinos } from '@/data/siteData'
import { DinosaurTypeEnum } from '@/components/utils'

export const prerender = false

// Extract dino param from the URL path
const { dino } = Astro.params
export const getStaticPaths = (() => {
    return dinos.map((dino) => ({
        params: { dino: dino.id.toLocaleLowerCase() },
    }))
}) satisfies GetStaticPaths

const matchingDino =
    dinos.find((dinoToMatch) => dinoToMatch.id.toLocaleLowerCase() === dino) ??
    dinos[0]

// Map dinosaur type to game data URL
const gameDataUrlMap: Record<DinosaurTypeEnum, string> = {
    [DinosaurTypeEnum.Aguja]: '/data/Agujaceratops.json',
    [DinosaurTypeEnum.Krito]: '/data/Kritosaurus.json',
    [DinosaurTypeEnum.Mosa]: '/data/Mosasaurus.json',
    [DinosaurTypeEnum.Protos]: '/data/Protes.json',
    [DinosaurTypeEnum.Tyranno]: '/data/Tyrannosaurus.json',
}

const gameDataUrl = gameDataUrlMap[matchingDino.id]

// Check if we should animate based on referrer, otherwise it doesn't make much sense
const referer = Astro.request.headers.get('referer') || ''
console.log('referer', referer)
const shouldAnimate = referer.includes('/select') || referer.endsWith('/select')
---

<Layout title={`Welcome ${matchingDino?.name ?? ''}`}>
    <PreloadSceneImages
        client:only="react"
        dinosaurType={matchingDino.id}
        gameDataUrl={gameDataUrl}
    />
    <DinoStartScreen
        client:only="react"
        {...matchingDino}
        shouldAnimate={shouldAnimate}
    />
</Layout>
